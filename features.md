# Alter0 Features（自部署 24x7 版本）

## 0. 前提与边界

- 部署形态：仅开发者本人自部署、自使用，单实例运行。
- 网络边界：默认本机或内网访问，不引入鉴权体系。
- 本阶段不做：账号体系、API 鉴权、限流、WAF、复杂 HTTP 抗压链路。
- 总目标：在上述边界下实现稳定 24 小时运行、可恢复、可维护。

## 1. 模型域需求

### 1.1 部署与运行模型（M1）

#### 目标

- 建立可长期运行的进程托管与恢复机制。

#### 需求点

- 提供 `systemd` 部署方案（服务文件、启动参数、日志路径、重启策略）。
- 提供 Docker 部署方案（Dockerfile、持久化目录、启动命令）。
- 启动前自检：SQLite 可写、执行器（`codex`/`claude`）可用、配置合法。
- 优雅停机：停止接收新请求，等待在途任务结束，超时后安全退出。
- 网关/通道异常要有明确事件日志与自动恢复路径。

#### 并行关系

- 可独立开发。
- 与数据与存储模型（M6）可并行，二者在启动流程汇合。

#### 验收标准

- 连续运行 24h 无人工干预。
- 进程异常退出可自动拉起。
- 停机后数据库无损坏、可正常重启服务。

### 1.2 任务路由模型（M2）

#### 目标

- 提升任务归属准确率，降低上下文漂移。

#### 需求点

- 路由 Prompt 模板版本化与可追踪。
- 路由输出结构化校验：`decision/task_id/confidence/reason`。
- 低置信度策略：统一降级为新任务。
- 路由日志记录：输入摘要、候选任务、决策原因、置信度。
- 增加回归样例集（连续追问、话题跳转、跨任务干扰）。

#### 并行关系

- 可独立开发。
- 与任务结题模型（M3）、执行模型（M4）并行。

#### 验收标准

- 典型回归集通过率达到预期阈值。
- 路由模型异常输出不导致崩溃，能稳定降级。

### 1.3 任务结题模型（M3）

#### 目标

- 降低误结题与长期悬挂任务比例。

#### 需求点

- 结题 Prompt 模板版本化与可追踪。
- 结题输出结构化校验：`close/confidence/reason`。
- 低置信度不结题，保持任务开放。
- 手动结题与自动结题规则一致化（状态、日志、统计口径）。
- 增加结题判定回归样例（已完成、部分完成、需追问、误判边界）。

#### 并行关系

- 可独立开发。
- 与任务路由模型（M2）、执行模型（M4）并行。

#### 验收标准

- 连续对话场景下无高频误关任务。
- 每次结题都有可追溯原因与置信度记录。

### 1.4 执行模型（M4）

#### 目标

- 在单机场景下提升执行可用性与吞吐稳定性。

#### 需求点

- 执行器适配层统一，错误类型统一归类。
- 执行并发度配置化（按 worker 数控制）。
- 长任务进入异步执行队列；短任务保留同步路径。
- 任务级超时、取消、重试策略（可配置次数与间隔）。
- 执行失败后的降级反馈与任务状态一致性保障。

#### 并行关系

- 可独立开发。
- 与交互模型（M5）在异步接口协议层汇合。

#### 验收标准

- 执行器偶发失败时任务可继续推进。
- 长任务不会阻塞全部请求链路。

### 1.5 交互模型（M5）

#### 目标

- 形成 CLI/HTTP/Web 一致的任务操作闭环。

#### 需求点

- HTTP 增加异步接口：提交任务、查询状态、取消任务。
- 保留同步 `/api/message` 作为短任务快速通道。
- `/api/status` 聚合关键运行态：gateway、scheduler、queue、executor。
- Web Console 增加任务列表、状态刷新、失败重试入口。
- CLI 增加异步任务查询与取消命令。

#### 并行关系

- 依赖执行模型（M4）提供异步执行能力。
- 与可观测与运维模型（M7）并行联调。

#### 验收标准

- Web 与 HTTP 可完成“提交-查询-结束/取消”闭环。
- 常见故障可在状态页定位到具体子模块。

### 1.6 数据与存储模型（M6）

#### 目标

- 保证升级可持续、数据可恢复、生命周期可治理。

#### 需求点

- Schema 迁移改为非破坏式版本迁移。
- 启动前自动备份数据库，支持手动恢复。
- 任务/消息/记忆/日志的分层保留策略配置化。
- 提供数据维护命令（备份、恢复、清理、校验）。
- 数据文件目录结构与命名规范化。

#### 并行关系

- 可独立开发。
- 与部署与运行模型（M1）在启动流程联动。

#### 验收标准

- 升级不丢失历史任务与消息。
- 故障恢复后可继续既有任务会话。

### 1.7 可观测与运维模型（M7）

#### 目标

- 降低排障时间，形成稳定运行反馈回路。

#### 需求点

- 统一结构化日志字段：`session_id/task_id/stage/user_id/channel_id`。
- 关键路径耗时统计：路由、生成、结题、队列等待、执行时长。
- 运行指标落地：任务总数、失败数、超时数、队列积压。
- 维护任务状态可视化（最近执行时间、最近错误、连续失败次数）。
- 日志滚动与归档策略（按天、按大小）明确化。

#### 并行关系

- 与交互模型（M5）并行，状态接口共同定义。

#### 验收标准

- 基于日志与状态接口可在 10 分钟内定位常见失败点。
- 关键运行指标可持续观测并用于回归对比。

### 1.8 工程交付模型（M8）

#### 目标

- 保证需求持续落地与发布可回滚。

#### 需求点

- 修复并稳定现有测试，建立必过门禁。
- 增加 24h soak test 脚本与结果记录模板。
- 发布物标准化：版本号、变更记录、升级步骤、回滚步骤。
- 引入模块级验收清单（每个模型域独立勾验）。
- 建立缺陷分级与修复时限约定（P0/P1）。

#### 并行关系

- 贯穿所有模块，作为统一质量收口。

#### 验收标准

- `go test ./...` 稳定通过。
- 关键回归场景可复现且有固定验收脚本。

## 2. 并行开发与里程碑

### 2.1 并行开发泳道

- 泳道 A：`M1 + M6`
- 泳道 B：`M2 + M3 + M4`
- 泳道 C：`M5 + M7`
- 质量收口：`M8`

### 2.2 里程碑建议

- P0：`M1 + M4 + M6 + M8`
- P1：`M2 + M3 + M5 + M7`

